package Malware::Finder;
use strict;
use Time::HiRes qw(gettimeofday tv_interval);

use Malware::Finder::Base;
use Malware::Finder::PHP;
use Malware::Finder::Config;


our $VERSION = '1.45';

sub new{
    my $class = shift;

    my $conf;

    # Se nos pasan un obxeto config usamolo
    # senon creamolo a partir dos args
    if(ref($_[0]) eq 'Malware::Finder::Config'){

        $conf = $_[0];
    }
    else{
    
        $conf = Malware::Finder::Config->new(@_);
    
    }

    my $parser_class = "Malware::Finder::".uc($conf->{lang});

    my $parser = $parser_class->new(
        %$conf,
    );

    return bless({
            config => $conf,
            parser => $parser
    });

}


sub parse{

    my $self = $_[0];

    my $t_start = [gettimeofday];

    if($self->{config}->{file}){
    
        print "Scanning '".$self->{config}->{file}."'\n";

        $self->{parser}->check_file(
            $self->{config}->{file}
        );
    }

    if($self->{config}->{dir}){

        print "Scanning '".$self->{config}->{dir}."'\n";

        $self->{parser}->analyze_files(
            $self->{config}->{dir},
            'main'
        );

    }

    printf ("Analysis finished in %.3fs\n",tv_interval($t_start));
}


